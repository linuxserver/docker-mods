name: Build Image

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    env:
      GHCR: "ghcr.io/linuxserver/mods" #don't modify
      BASEIMAGE: "baseimagename" #replace
      MODNAME: "modname" #replace

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.3

      - name: Build image
        id: build
        run: |
          docker build --no-cache -t ${GHCR}:${BASEIMAGE}-${MODNAME}-${{ github.sha }} .

      - name: Push image
        if: ${{ github.ref == format('refs/heads/{0}-{1}', env.BASEIMAGE, env.MODNAME) }}
        run: |
          # Tag image
          docker tag ${GHCR}:${BASEIMAGE}-${MODNAME}-${{ github.sha }} ${GHCR}:${BASEIMAGE}-${MODNAME}
          # Login to ghcr
          echo ${{ secrets.GHCRPASS }} | docker login -u ${{ secrets.GHCRUSER }} --password-stdin
          # Push all of the tags
          docker push ${GHCR}:${BASEIMAGE}-${MODNAME}-${{ github.sha }}
          docker push ${GHCR}:${BASEIMAGE}-${MODNAME}
